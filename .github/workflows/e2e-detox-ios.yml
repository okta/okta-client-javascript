name: Detox E2E - iOS

on:
  pull_request:
    branches:
      - main
      - migration/react-native
      - migration/rn-upgrade-webcrypto-poc
  push:
    branches:
      - main
      - migration/react-native
      - migration/rn-upgrade-webcrypto-poc

jobs:
  detox-ios:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Install iOS tools
        run: |
          brew update
          brew tap wix/brew
          brew install applesimutils
          brew install watchman || true

      - name: Print Xcode version
        run: |
          xcodebuild -version
          xcode-select -p

      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4"

      - name: Prebuild (Expo) + Install Pods
        run: |
          set -euo pipefail
          cd e2e/apps/react-native-oidc

          # Prebuild (generate ios / and the .xcworkspace)
          EXPO_NO_GIT_STATUS=1 yarn expo prebuild --clean --no-install

          echo "------ ios folder -------"
          ls -la ios || true

          echo "------ projects ---------"
          ls -la ios/*.xcodeproj || true

          # Intall CocoaPods

          cd ios
          if [[ -f Gemfile ]]; then
            gem install bundler
            bundle install
            bundle exec pod install --repo-update
          else
            sudo gem install cocoapods -N
            pod install --repo-update
          fi

          cd ..

          echo "------ workspaces -------"
          ls -la ios/*.xcworkspace || true

          # Ensure the workspace was created
          WORKSPACE="$(ls -1 ios/*.xcworkspace | head -n 1 || true)"
          if [ -z "$WORKSPACE" ]; then
            echo "ERROR: No .xcworkspace found in ios/ after expo prebuild"
            exit 1
          fi
          echo "Detected workspace: ${WORKSPACE}"

          echo "------ toolchain umbrella -------"
          ls -la ios/Pods/Headers/Public/React-Core/React-Core-umbrella || true
          echo "--------------------------------"

      - name: Boot simulator
        run: |
          set -euo pipefail

          # Prefered device if available; fallback to any available iPhone simulator
          xcrun simctl boot "iPhone 16e" || true
          xcrun simctl list devices available

      - name: Build + Test Detox
        run: |
          set -euo pipefail
          yarn workspace @repo/react-native-oidc e2e:build:ios
          yarn workspace @repo/react-native-oidc e2e:test:ios
